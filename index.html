<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SmartBin</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>

<body>
<!-- (CSS à¹à¸¥à¸° HTML à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡ à¹„à¸¡à¹ˆà¸•à¸±à¸”à¸­à¸­à¸à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸±à¹‰à¸™) -->

<script>
const URL="https://teachablemachine.withgoogle.com/models/EV-mbCqpx/";

let model, webcam, maxPredictions;
let isCameraOn=false;
let currentFacingMode="environment";
let loopId=null;

/* à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ */
async function loadModel(){
model=await tmImage.load(URL+"model.json",URL+"metadata.json");
maxPredictions=model.getTotalClasses();
createBars();
}
loadModel();

/* à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡ */
async function startCamera(){

const flip = currentFacingMode === "user";

webcam = new tmImage.Webcam(400,400,flip);
await webcam.setup({facingMode:currentFacingMode});
await webcam.play();

document.getElementById("webcam-container").innerHTML="";
document.getElementById("webcam-container").appendChild(webcam.canvas);

document.getElementById("placeholder").style.display="none";
document.getElementById("switchBtn").style.display="block";

isCameraOn=true;
loop();
}

/* à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡ */
async function stopCamera(){
if(loopId) cancelAnimationFrame(loopId);
if(webcam) await webcam.stop();

document.getElementById("webcam-container").innerHTML="";
document.getElementById("placeholder").style.display="block";
document.getElementById("switchBtn").style.display="none";

resetBars();
isCameraOn=false;
}

/* à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¸´à¸”/à¸›à¸´à¸” */
async function toggleCamera(){
if(isCameraOn){
await stopCamera();
}else{
await startCamera();
}
}

/* ðŸ”¥ à¸ªà¸¥à¸±à¸šà¸à¸¥à¹‰à¸­à¸‡à¹à¸šà¸šà¹„à¸¡à¹ˆà¸‚à¸­ permission à¹ƒà¸«à¸¡à¹ˆ */
async function switchCamera(){

if(!isCameraOn) return;

currentFacingMode =
currentFacingMode==="environment" ? "user" : "environment";

/* à¸«à¸¢à¸¸à¸” stream à¹€à¸”à¸´à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¸µà¸¢à¸§ */
await webcam.stop();

/* à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆà¸”à¹‰à¸§à¸¢ flip à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ */
const flip = currentFacingMode === "user";
webcam = new tmImage.Webcam(400,400,flip);

await webcam.setup({facingMode:currentFacingMode});
await webcam.play();

document.getElementById("webcam-container").innerHTML="";
document.getElementById("webcam-container").appendChild(webcam.canvas);
}

/* Loop */
async function loop(){
if(!isCameraOn) return;

webcam.update();
await predict();

loopId=requestAnimationFrame(loop);
}

/* Predict */
async function predict(){
const prediction=await model.predict(webcam.canvas);

prediction.forEach(p=>{
const percent=Math.round(p.probability*100);
updateBar(p.className,percent);
});
}

function updateBar(label,percent){
const bar=document.getElementById("bar-"+label);
const text=document.getElementById("text-"+label);

if(bar){
bar.style.width=percent+"%";
text.innerText=percent+"%";
}
}

function resetBars(){
document.querySelectorAll(".progress-fill")
.forEach(e=>e.style.width="0%");

document.querySelectorAll(".percent-text")
.forEach(e=>e.innerText="0%");
}

/* Tabs */
function showCamera(){
document.getElementById("cameraPage").style.display="flex";
document.getElementById("infoPage").style.display="none";
}

function showInfo(){
document.getElementById("cameraPage").style.display="none";
document.getElementById("infoPage").style.display="block";
}
</script>
</body>
</html>
